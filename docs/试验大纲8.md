## 实验 8：QAE 对 Hankel 估计的加速

（对应定理 12.3）

### 0. 理论目标回顾

定理 12.3 说的是：如果在构造经验 Hankel $\widehat H$ 时，用 QAE (Quantum Amplitude Estimation) 来估计每个概率条目，那么
$$
\|\widehat H - H\|_2
\ \lesssim\
C_1\frac{1}{K}\sqrt{\frac{\mu \log((m+n)/\delta)}{N}}
\ +\ 
C_2\frac{\log((m+n)/\delta)}{N}
\ +\ b_K,
$$

- $N$：“外层”样本数（one-shot 轮数）；
- $K$：每一轮内 QAE 使用的查询次数（Grover 迭代轮数）；
- $\mu$：相干度；
- 关键点：**第一项的方差前因子随 $1/K$ 缩放**，而经典频数估计对应的是 $1/\sqrt{\text{查询次数}}$。

**实验目标：**

1. 在**单一概率振幅**上验证：QAE 的估计误差（均方根）随 $K$ 近似按 $1/K$ 缩放。
2. 在**整块 Hankel 矩阵**层面，固定 $N$，考察
    $\|\widehat H_{K,N}-H\|_2$ 随 $K$ 的缩放，是否接近 $1/K$。

------

## Part A：单一振幅的 QAE 缩放（warm-up）

这个部分不涉及 Hankel，只是纯粹验证 QAE 的标准误差标度。

### A.1 目标与设定

选择一个固定的概率值 $p \in (0,1)$（例如 $p=0.15$ 或你模型中某个事件的真实概率），模拟两种估计方式：

- 经典采样：频数估计 $\hat p_{\text{cl}}$；
- QAE：按 ideal 算法得到 $\hat p_{\text{QAE},K}$（每次使用 K 次 oracle/query）。

看 $\mathbb E|\hat p - p|$ 或 $\sqrt{\mathbb E(\hat p-p)^2}$ 如何随 K 变化。

### A.2 模拟 QAE 的两种实现方案

你可以选其一：

**方案 (1)：理想算法仿真（小规模量子电路）**

- 定义单 qubit “good state” 制备算子 $U_p$：
  $$
  U_p|0\rangle = \sqrt{p}\,|1\rangle + \sqrt{1-p}\,|0\rangle.
  $$

- 定义 oracle $O_{\rm good}$ 标记 $|1\rangle$，Grover 算子 $Q = -U_p S_0 U_p^\dagger S_f$；

- 标准 QAE 算法：用 $m$ 个辅助 qubit，对 $\{Q^{2^j}\}_{j=0}^{m-1}$ 控制应用，做 QFT，测量得到一个估计 $\tilde\theta$，再转成 $\hat p = \sin^2(\tilde\theta)$。其中 $K\approx 2^m$ 控制总体查询次数。

- 用 statevector 仿真器跑多次，统计 $|\hat p - p|$ 的均值/MSE。

**方案 (2)：直接用理论误差模型采样（快 & 足够）**

若你不想搭完整 QAE 电路，可以用一个“理论 noise model”近似：

- 理想 QAE 的误差满足 $\mathbb E|\hat p-p|=O(1/K)$，分布近似集中；

- 你可以用一个简化模型：
  $$
  \hat p_{\text{QAE},K}=p + \frac{Z}{K},
  $$
  其中 $Z$ 是零均值的随机变量（例如截断高斯或简单的离散偏差）：

  - 例如选 $Z\sim\mathcal N(0,\sigma_0^2)$，再把 $\hat p$ 截断到 $[0,1]$ 区间即可；
  - 或者用更接近理论的离散分布（比如取若干固定偏移 $\pm c/K$ 等）。

这不追求真实 QAE 的细节，而是用“仿真噪声”来验证缩放趋势：error $\propto 1/K$。

### A.3 实验流程

对一组 $K$ 值，如：
$$
K\in\{1,2,4,8,16,32\},
$$
进行如下步骤：

1. 固定 $p$（或多选几组 $p$）；
2. 对每个 K，重复 $R$ 次（比如 $R=1000$）：
   - 经典采样：用 $T_{\text{cl}}$ 次伯努利试验得到 $\hat p_{\text{cl}}$，其中 $T_{\text{cl}}$ 可固定，如 1000；
   - QAE：用你选择的方案得到 $\hat p_{\text{QAE},K}$；
3. 统计：
   - $E_{\rm cl}=\mathbb E|\hat p_{\text{cl}}-p|$ 或 MSE；
   - $E_{\rm QAE}(K)=\mathbb E|\hat p_{\text{QAE},K}-p|$ 或 MSE。

### A.4 指标与预期

- 画图 1：log–log：$E_{\rm QAE}(K)$ vs $K$，线性拟合斜率 $\approx -1$，即误差 ~ $K^{-1}$。
- 对比：经典采样如果你同时扫描采样次数 $T$，会得到斜率 $-1/2$（$\sim T^{-1/2}$）。

这部分是 warm-up，用来单点验证 QAE 的 $1/K$ 缩放。

------

## Part B：整块 Hankel 的 QAE 加速（对应定理 12.3）

这一部分就完全按照你写的思路，把 QAE 嵌入 Hankel 估计 pipeline 里。

### B.1 模型与真 Hankel

选一个小规模 QCBM/MPS 模型，长度 L 小到可枚举：

- 字母表 $\Sigma=\{0,1\}$；
- 序列长度 $L\in\{6,8\}$（例如 L=8）；
- 键维 D 取 2 或 3（保证模型非平凡）；
- 用你前面实验 1–3 的方式生成一个随机 MPS / QCBM，并规范化；
- 固定切分点 $t_*=\lfloor L/2\rfloor$，令 $P=\Sigma^{t_*}, S=\Sigma^{L-t_*}$。

由模型精确计算真值：

- 对每个 $x\in\Sigma^L$，算出 $p(x)$;

- 构造真 Hankel：
  $$
  H(u,v) = p(uv),\quad u\in P,\ v\in S.
  $$

------

### B.2 经典频数估计版 Hankel（baseline）

这就是你第 9 章–实验 5 里面的 classical Hankel 估计方式，用来做对照：

1. 从模型 $p$ 中 i.i.d. 抽样 N 个长度 L 的样本 $x^{(1)},\dots,x^{(N)}$；

2. 对每个样本切分 $x^{(i)}=u^{(i)}v^{(i)}$，计数：
   $$
   \widehat H_{\rm cl}(u,v)=\frac{1}{N}\sum_{i=1}^N \mathbf 1\{u^{(i)}=u,\ v^{(i)}=v\}.
   $$

3. 计算经典 Hankel 误差：
   $$
   \Delta_{\rm cl} := \|\widehat H_{\rm cl}-H\|_2.
   $$

这部分主要是 baseline，不是本实验的重点，但可以用来比较 QAE 的效果。

------

### B.3 QAE 加持版 Hankel 估计

这里有两种接近定理 12.3 的理解方式。为了实验简单，我们可以把“QAE 误差”直接当作概率估计的额外缩放因子。

**概念重述（简化版）**

- Hankel 的每个条目 $H(u,v)=p(uv)$ 是某个 0–1 事件的概率（事件为 “序列等于 uv”）；
- 经典估计：看 N 次采样中有多少次发生；
- QAE 估计：假设我们有一个量子 oracle，能制备编码该事件的状态，并对它用 K 轮 QAE 得到更精确的 $\hat p_{K}$。

为了避免对每个 $(u,v)$ 都跑一遍 QAE 的指数成本，我们**实验上可以只做“独立条目噪声模型”**：
 即认为 $\widehat H_K(u,v)$ 是 $H(u,v)$ 加上一个 QAE 型噪声项，方差缩放 $\sim 1/(K^2 N)$。

#### (1) 构造 QAE 版 Hankel 噪声模型

在给定一组样本的基础上，可以这样模拟：

1. 先用 N 个样本构造经典频数版 $\widehat H_{\rm cl}(u,v)$，它可以看作是
   $$
   \widehat H_{\rm cl}(u,v) = H(u,v) + \xi_{\rm cl}(u,v),
   $$
   其中 $\xi_{\rm cl}(u,v)$ 的标准差 $\sim \sqrt{H(u,v)(1-H(u,v))/N}$。

2. 引入 QAE 对 var 的缩放：在 QAE 模型下，**同样的 N 轮“外层访问” +每轮 K 次 amplitude queries**，方差会多乘一个 $1/K^2$：

   模拟：
   $$
   \hat H_{K,N}(u,v)
   = H(u,v) + \xi_{\rm qae}(u,v),
   $$
   其中
   $$
   \xi_{\rm qae}(u,v) \sim \mathcal N\!\left(0,\ \frac{c\cdot H(u,v)(1-H(u,v))}{N K^2}\right),
   $$
   c 是一个常数系数（理想 QAE 下 c 约为常数量级）。

   实现上：

   - 你可以直接用 $\widehat H_{\rm cl}(u,v)$ 作为“粗估”，再加一个额外的高斯噪声减小方案，或
   - 直接从真值 $H(u,v)$ 出发按照上述方差采样 $\xi_{\rm qae}$（这样就纯粹看 QAE 的理论缩放，而不混入 classical 的 1/√N）。

3. 为了贴合定理 12.3，把 QAE 误差写成两部分：

   - 主方差项 $\propto 1/K\sqrt{1/N}$（上式中的高斯部分）；
   - 一个固定的 bias $b_K$（例如尺度 ~$O(1/K)$ 或 1/K²），你可以在仿真里加入一个小 deterministic 偏移（或干脆忽略）。

**小结：**
 在数值实验中，你可以直接定一个“QAE 噪声模型”来生成 $\widehat H_{K,N}$，而不必真的写 QAE 电路。重要的是噪声强度 ∝ $1/(K\sqrt{N})$。

#### (2) 固定 N，扫 K

选择一个较大的 N（比如 $N=10^4$ 或 $2\times 10^4$），让第二项 $C_2\log/N$ 基本淹没在噪声之下，方便观察 $1/K$ 的主导行为。

- 取 $K\in\{1,2,4,8,16,32\}$；

- 对每个 K，重复 R 次（例如 R=50）：

  1. 根据噪声模型生成一次 $\widehat H_{K,N}$；

  2. 计算 Hankel 误差：
     $$
     \Delta_{K,N} := \|\widehat H_{K,N}-H\|_2.
     $$

- 记录 $\Delta_{K,N}$ 的均值 / 中位数 $\overline\Delta_{K,N}$。

------

### B.4 可视化与对比

**1）误差 vs K（核心图）**

- log–log 图：

  - x 轴：$\log K$；
  - y 轴：$\log \overline\Delta_{K,N}$。

- 对所有 K 做一阶线性拟合：
  $$
  \log \overline\Delta_{K,N} \approx a - b\log K.
  $$

- 预期：$b\approx 1$（即 $\overline\Delta_{K,N}\propto 1/K$）。

- 可以在图上画一条参考线 $1/K$ + 一个常数偏置。

**2）和经典 Hankel 估计的对比（选做）**

- 经典版：对不同总“查询数” $Q$（即样本数 N），测量经典误差 $\|\widehat H_{\rm cl}^{(N)}-H\|_2$，验证 $\sim 1/\sqrt{Q}$；
- QAE 版：对不同“总查询数” $Q'=N\times K$（每次 N 外层 × 每轮 K 查询），验证：
  - 若把 $\overline\Delta_{K,N}$ 画成 $Q'$ 的函数，应该看到 QAE 对应的斜率更陡（更快下降），即 **量子二次加速** 的直观表现。

------

### B.5 写在论文里的描述示例

在第 12 章实验部分，可以这样写：

> We perform a numerical experiment to validate the quantum-amplitude-estimation (QAE) enhanced Hankel concentration bound in Theorem 12.3. For a small QCBM/MPS model with sequence length $L=8$, we first compute the exact Hankel matrix $H_p(P,S)$. Then, we construct synthetic QAE-based Hankel estimates $\widehat H_{K,N}$, where the entry-wise noise is modeled as zero-mean with variance scaling as $O(1/(N K^2))$, in accordance with the ideal QAE variance reduction. For a fixed outer sample size $N$, we vary the number of QAE queries $K$ and measure the spectral error $\|\widehat H_{K,N}-H\|_2$.
>
> On a log–log scale, the average error $\mathbb E\|\widehat H_{K,N}-H\|_2$ decays approximately linearly with slope close to $-1$ as a function of $K$, confirming the predicted $1/K$ scaling of the leading variance term in Theorem 12.3. By contrast, the classical frequency-based estimator exhibits the usual $O(1/\sqrt{Q})$ behavior as a function of the total number of oracle queries $Q$, whereas the QAE-based estimator effectively achieves $O(1/Q)$ scaling, illustrating the quadratic advantage of quantum amplitude estimation in the context of Hankel matrix learning.