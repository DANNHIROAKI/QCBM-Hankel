# 实验 8：QAE 对 Hankel 估计的加速

> 对应理论：第 12 章定理 12.3（QAE 增强的 Hankel 集中不等式）

------

## 0. 理论目标与实验角色

### 0.1 定理 12.3（简化版）

定理 12.3 声称：当用 QAE 来估计概率并构造经验 Hankel 矩阵 $\widehat H$ 时，在理想模型下有（忽略常数和对数因子）：
$$
\|\widehat H - H\|_2
\;\lesssim\;
\underbrace{\frac{1}{K}\sqrt{\frac{\mu}{N}}}_{\text{QAE 方差项}}
\;+\;
\underbrace{\frac{1}{N}}_{\text{有界差分项}}
\;+\;
\underbrace{b_K}_{\text{QAE 偏差项}}.
$$

- $N$：外层轮数（类比“one-shot 采样轮数”）
- $K$：每轮 QAE 的查询次数（oracle 调用数）
- $\mu$：Hankel 相干度
- $b_K$：QAE 算法自身的偏差项（典型为 $O(1/K)$ 或更小）

若用总 query 数 $Q = N K$ 来比较：

- 经典频数估计：误差 $\sim Q^{-1/2}$
- 理想 QAE：主方差项 $\sim Q^{-1}$ —— **二次加速**

### 0.2 实验 8 的定位（一定要在论文里说清）

实验 8 刻意拆成两层：

1. **层 1：理想噪声模型下的 scaling 插图（主实验）**
   - 假设“单个 $p(x)$ 的估计方差 $\propto p(1-p)/(N K^2)$、偏差 $\propto 1/K$”已经成立；
   - 在这个 entry-wise 噪声模型前提下，验证：
     - 单一振幅的 RMSE 是否随 $K$ 呈 $1/K$；
     - 整块 Hankel 的谱范数/ Frobenius 范数误差是否随 $K$ 呈 $1/K$，随 $N$ 呈 $1/\sqrt N$。
2. **层 2：小规模真实 QAE 仿真（补强）**
   - 在 1–2 比特上用量子模拟器跑真实 QAE；
   - 检查单振幅 RMSE vs $K$ 的斜率是否 ≈ -1，以验证“理想噪声模型”确实反映了实际 QAE 的主要 scaling。

> 写 paper 时：
>
> - 对 Part A/B，要明确说是**理想噪声模型下的数值插图**；
> - 对 Part C，说它是对噪声模型合理性的一个小规模“sanity check”。

------

## 1. 整体结构与参数空间

### 1.1 三个子实验

- **Part A：单一振幅 QAE 缩放（warm-up）**
  - 关注：标量概率估计的 RMSE vs $K$、vs $N$。
- **Part B：整块 Hankel 的 QAE 缩放（主实验）**
  - 关注：$|\widehat H_{K,N}-H|*2$ 和 $|\widehat H*{K,N}-H|_F$ 对 $K$ 和 $N$ 的 scaling，以及对 classical baseline 的提升。
- **Part C（扩展）：真实 QAE 仿真**
  - 关注：真实 QAE 的 RMSE vs $K$ 是否与 Part A 噪声模型匹配。

### 1.2 建议参数（与 `exp8_qae_scaling.py` 对齐）

主脚本已经支持以下参数：exp8_qae_scaling

- **Part A（amplitude 部分）**
  - 真概率：`--amplitude-probs "0.15,0.35"`
  - classical shots：`--amplitude-shots ∈ {500, 1000, 2000}`（可多跑几档 N 做 N-scaling）
  - 试验次数：`--amplitude-trials 500`
  - QAE 查询数集合：`--qae-rounds "1,2,4,8,16,32"`
- **Part B（Hankel 部分）**
  - 序列长度：`--lengths "6,8"`
  - 字母表大小：`--d 2`
  - 键维：`--bond-dim 3`
  - classical 样本数：`--sample-size ∈ {2000, 5000, 10000}`（可以通过多次运行脚本改变此参数）
  - Hankel trial 数：`--trials 20`
- **QAE 噪声模型**
  - `--noise-scale 1.0`（可扫 0.5, 1.0, 2.0 做鲁棒性检查）
  - `--bias-scale 0.0`（主实验无偏；再加一组 `0.05` 看偏差主导阶段）
- **公共参数**
  - `--seed` 控制随机数种子
  - `--output` 指定 CSV 路径（默认 `experiments/exp8_results.csv`）

------

## 2. Part A：单一振幅的 QAE 缩放

### 2.1 目标

1. 在理想 QAE 噪声模型下，验证：
   - 固定 `shots = T_cl` 时，QAE-style RMSE($K$) $\propto 1/K$；
   - 固定 $K$ 时，RMSE($T_cl$) $\propto 1/\sqrt{T_cl}$；
2. 展示 `bias_scale > 0` 时，在大 $K$ 区间误差由偏差项 $b_K$ 主导的“饱和/平台”现象。

### 2.2 估计器定义

**经典频数估计**

- 对 $p_{\text{true}}$，做 `classical_shots` 次伯努利试验：
  $$
  \hat p_{\text{cl}} = \frac{C}{T_{\text{cl}}},\quad C\sim\text{Binomial}(T_{\text{cl}}, p_{\text{true}}).
  $$

**QAE-style 估计（脚本函数 `qae_amplitude_estimate`）**exp8_qae_scaling

- 模型：
  $$
  \hat p_{\text{QAE},K}
  = \mathrm{clip}_{[0,1]}\Big(p_{\text{true}} + \underbrace{\frac{\text{bias\_scale}}{K}}_{\text{偏差项}} + Z_K\Big),
  $$

  $$
  Z_K \sim \mathcal N\Big(0,\;\sigma^2\Big),\quad
  \sigma^2 = \frac{\text{noise\_scale}\cdot \max(p(1-p), 10^{-12})}{T_{\text{cl}} K^2}.
  $$

- 直接编码了理论里 **方差 $\propto 1/(T_{\text{cl}}K^2)$** 和偏差 $\propto 1/K$。

### 2.3 流程

对每个 $p_{\text{true}}$（如 0.15, 0.35）：

1. 设定一组 $T_{\text{cl}}$（例如 500, 1000, 2000）；
2. 对每个 $(T_{\text{cl}}, K)$：
   - 重复 `amplitude_trials` 次：
     - 生成 $\hat p_{\text{cl}}$（classical）；
     - 生成 $\hat p_{\text{QAE},K}$（QAE-style）；
     - 记录 `abs_error` 和 `sq_error`。
3. 所有结果写入 CSV（脚本已经完成，`section="amplitude"` 这一块）。exp8_qae_scaling

### 2.4 分析与预期现象

**(1) RMSE vs K（固定 shots）**

- 固定一个 $T_{\text{cl}}$ 和 $p_{\text{true}}$；
- 对每个 K：
  - classical：只在 K=0 有一条基线 RMSE；
  - QAE-style：$RMSE(K) = \sqrt{\mathbb E[(\hat p_{\text{QAE},K}-p)^2]}$；
- 在 log–log 坐标画：
  - 横轴：$\log K$，纵轴：$\log RMSE(K)$；
  - 对 QAE-style 做线性拟合，斜率 $b_K \approx -1$；

**(2) RMSE vs shots（固定 K）**

- 固定一个 K（例如 K=4,16）；
- 画 $\log RMSE$ vs $\log T_{\text{cl}}$，预期斜率 ≈ -1/2，对齐 $\sqrt{1/N}$ 依赖。

**(3) 偏差项主导（bias_scale > 0）**

- 设 `bias_scale=0.05` 再跑一组；
- 预期：
  - 中小 K：RMSE ≈ 方差主导，仍近似 $\propto 1/K$；
  - 大 K：RMSE 降到某个阈值附近后出现平台/缓降，对应偏差 $\approx \text{bias\_scale}/K$ 主导。

------

## 3. Part B：整块 Hankel 的 QAE 缩放

### 3.1 Ground truth 模型和 Hankel 定义

**随机 MPS/QCBM 模型**（脚本 `sample_random_mps_distribution`）

- 字母表 $\Sigma = {0,1}$ (`d=2`)；

- 长度 $L\in{6,8}`；

- 键维 `bond_dim=3`；

- 构造随机复矩阵 $A(\sigma)$ 和边界向量 $\alpha,\beta$，振幅：
  $$
  \psi(x) = \alpha^\top\Big(\prod_t A(x_t)\Big)\beta,\quad p(x)=|\psi(x)|^2,
  $$
  再 normalize 为合法分布。

**mid-cut Hankel**（脚本 `build_hankel`）exp8_qae_scaling

- 切分点 $t_* = \lfloor L/2\rfloor$；

- 前缀集 $P=\Sigma^{t_*}$，后缀集 $S=\Sigma^{L-t_*}$；

- Hankel：
  $$
  H(u,v) = p(uv),\quad u\in P,\ v\in S.
  $$

### 3.2 经典 Hankel 估计（baseline）

**采样 & 估计**（脚本 `sample_classical`）exp8_qae_scaling

- 从 $p$ 中采样 `sample_size = N` 个序列；

- 对所有 $x=uv$，估计 $\hat p_{\text{cl},N}(x)$；

- 构造：
  $$
  \widehat H_{\text{cl},N}(u,v)=\hat p_{\text{cl},N}(uv).
  $$

**误差指标**
$$
\Delta_{\text{cl}}^{\text{spec}} = \|\widehat H_{\text{cl},N}-H\|_2,\quad
\Delta_{\text{cl}}^{\text{fro}} = \|\widehat H_{\text{cl},N}-H\|_F.
$$

### 3.3 QAE-style Hankel 估计（理想噪声）

**分布级 QAE 噪声模型**（脚本 `qae_distribution_estimate`）exp8_qae_scaling

- 对每个 $x$：
  $$
  \hat p_{K,N}(x)
  = \mathrm{clip}_{[0,1]}\Big(
        p(x) + \frac{\text{bias\_scale}}{K}
        + Z_{K,N}(x)
    \Big),
  $$

  $$
  Z_{K,N}(x)\sim\mathcal N\Big(
      0,\;
      \frac{\text{noise\_scale}\cdot \max(p(x)(1-p(x)),10^{-12})}{N K^2}
  \Big),
  $$

- 然后归一化，得到 $\hat p^{\rm norm}_{K,N}(x)$；

- QAE-style Hankel：
  $$
  \widehat H_{K,N}(u,v)=\hat p^{\rm norm}_{K,N}(uv).
  $$

**误差指标**
$$
\Delta_{K,N}^{\text{spec}}(L)=\|\widehat H_{K,N}-H\|_2,\quad
\Delta_{K,N}^{\text{fro}}(L)=\|\widehat H_{K,N}-H\|_F.
$$

### 3.4 采样设计与脚本逻辑

脚本 `run_hankel_part` 的流程（略化后）：

对每个长度 `length in lengths`：

1. 重复 `trials` 次：
   - 生成随机 MPS 分布 `prob_map`；
   - 构造真 Hankel `hankel_true`；
   - classical：用 `sample_classical(prob_map, sample_size=N)` 得到 `classical_map`，算 Hankel 误差；
   - 对每个 `K in qae_rounds`：
     - 用 `qae_distribution_estimate` 得到 QAE-style `qae_map`；
     - 构造 Hankel，计算 `error_spec` 和 `error_fro`。
2. 输出 CSV 行，字段包括：
   - `section="hankel"`，`length, d, bond_dim, trial, sample_size, method, K, error_spec, error_fro` 等。

如果要做 **$N$ scaling**，可以多跑几次脚本，只改 `--sample-size`，然后在分析脚本里把多个 CSV 合并。

### 3.5 分析一：误差 vs K（固定 N）

**目标：验证 $\Delta_{K,N}^{\text{spec}} \propto 1/K$**

1. 对每个长度 $L$ 和固定 $N$：

   - 对每个 K，将 trial 维度上的 `error_spec` 取平均或中位数：
     $$
     \overline\Delta^{\text{spec}}_{K,N}(L)
     = \mathbb E_{\text{trial}}[\Delta_{K,N}^{\text{spec}}(L)].
     $$

2. 在 log–log 坐标绘图：

   - 横轴：$\log K$；
   - 纵轴：$\log \overline\Delta^{\text{spec}}_{K,N}(L)$；

3. 对 QAE-style 点做线性拟合：

   - 期望斜率 $b_{L,N}\approx -1$；
   - classical baseline（`method="classical", K=0`）对应一条水平线作 reference。

同理，对 Frobenius 误差 `error_fro` 做同样分析。

### 3.6 分析二：误差 vs N（固定 K）

**目标：验证 $\Delta_{K,N}^{\text{spec}} \propto 1/\sqrt N$**

- 将多个 `sample_size` 的结果合并；
- 对固定 $(L,K)$，画 $\log \overline\Delta^{\text{spec}}_{K,N}(L)$ vs $\log N$；
- classical 与 QAE-style 理论上都应表现出斜率约 -1/2，这对应定理中的 $\sqrt{\mu/N}$ 因子。

### 3.7 分析三：误差 vs 总 query 数 Q

为直观比较“二次加速”，可以换轴：

- classical：总 query 数 $Q_{\text{cl}} = N$，误差 $\Delta_{\text{cl}}^{\text{spec}}(L,N)$；
- QAE-style：总 query 数 $Q_{\text{QAE}} = N K$，误差 $\overline\Delta_{\text{QAE}}^{\text{spec}}(L,Q)$；
- 把两类点都画在 log–log“误差 vs Q”的图上，拟合斜率：
  - classical：期望斜率 ≈ -1/2；
  - QAE-style：期望斜率 ≈ -1（即误差 $\sim 1/Q$）——这就是二次加速。

### 3.8 分析四：偏差项 b_K 的 Hankel 级影响（扩展）

- 把 `bias_scale` 设置为 0.05 或更大，再跑一组；
- 对误差 vs K 的 log–log 图：
  - 中小 K 区间：仍近似 slope ≈ -1；
  - 大 K 区间：曲线弯平，出现偏差主导的“误差平台”，对应定理中的 $b_K$ 项。

------

## 4. Part C：真实 QAE 仿真（小规模补强）

> 这一块可以写成新脚本 `exp8_qae_real_sim.py`，只需要在补充材料中给结果图即可。

### 4.1 目标

- 检查真实 QAE 算法在 toy 模型下是否表现出 RMSE vs K 的 $1/K$ scaling；
- 说明我们在 Part A/B 所用的噪声模型是“理想 QAE 行为”的合理近似。

### 4.2 设置

- 目标振幅：在单比特上构造
  $$
  U_p|0\rangle=\sqrt{1-p}|0\rangle+\sqrt p|1\rangle,\quad p\in\{0.15,0.35\};
  $$

- 选择一种实现简单的 QAE 方案（标准 QPE-based 或迭代 QAE 都可），记 ancilla 比特数为 $m$；

- 通常 query 数 $K\approx 2^m$，取 $m\in{1,2,3,4,5}$。

### 4.3 流程

对每个 $(p, m)$：

1. 运行 QAE 算法 $R_C$ 次（如 200 次），得到估计 $\hat p_{\text{real},K}$；
2. 记录误差：$|\hat p-p|$、$(\hat p-p)^2$；
3. 计算 RMSE($K$) 并在 log–log 坐标下画图，拟合斜率 $b^{\text{real}}$。

### 4.4 对比与结论

- 将 $b^{\text{real}}$ 与 Part A 噪声模型下的斜率 $b^{\text{model}}$ 比较；
- 若二者接近 -1，就可以在论文中写一句话：

> “Small-scale circuit-level simulations of amplitude estimation confirm that the empirical RMSE decays approximately as $1/K$, consistent with our idealised QAE noise model used in Experiments 8A and 8B.”

------

## 5. 实现与复现说明

- **主脚本**：`exp8_qae_scaling.py` 已经完整实现了 Part A 和 Part B 的采样与 CSV 落盘逻辑，只需通过命令行修改参数即可覆盖不同 N 和 bias_scale 的设置。exp8_qae_scaling
- **输出格式**（统一 header）：
  - `section`（"amplitude"/"hankel"）、`length`、`d`、`bond_dim`、`trial`、`sample_size`、`method`、`K`、`error_spec`、`error_fro`、`p_true`、`abs_error`、`sq_error`。
  - 利用 `section` 字段区分两类实验，在分析脚本中很方便。
- **随机性控制**：
  - `--seed` 控制 Python `random` 和 `numpy.random`；
  - 建议在 paper 中固定一两个种子配置，并说明运行时间量级。
- **分析脚本**：
  - 单独写一个 `analyze_exp8.ipynb` 或 Python 脚本，负责读多个 CSV，做 log–log 回归、画图、输出斜率和置信区间。