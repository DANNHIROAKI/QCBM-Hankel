## 实验 2：截断误差与 Hankel 有效秩

（验证定理 4.2 & 推论 4.3）

### 1. 目标与理论回顾

**理论要点：**

- 对原始 MPS 态 $\psi$ 和截断后态 $\tilde\psi$：
  $$
  \|\psi-\tilde\psi\|_2 \;\le\; \Big(\sum_{t}\epsilon_t^2\Big)^{1/2},
  $$
  其中 $\epsilon_t^2$ 是第 $t$ 个 Schmidt 切分的尾能量。

- 概率 Hankel 的误差满足（忽略“每个串出现多少次”的常数因子）：
  $$
  \|H_p-\tilde H_p\|_2 \;\lesssim\; 2\Big(\sum_t\epsilon_t^2\Big)^{1/2} =: \Delta_H.
  $$

- 推论 4.3：对于任意 $\varepsilon\ge \Delta_H$，有效秩满足
  $$
  \operatorname{rank}_\varepsilon(H_p)\;\le\; D_{\rm eff}^2.
  $$

**实验目标：**

1. 数值验证：$\|H_p-\tilde H_p\|_2$ 与 $\big(\sum_t\epsilon_t^2\big)^{1/2}$ 呈近似线性关系，并被 $2\big(\sum_t\epsilon_t^2\big)^{1/2}$ 这条理论上界牢牢“罩住”。
2. 验证：当容差 $\varepsilon \ge \|H_p-\tilde H_p\|_2$ 时，$H_p$ 的有效秩 $\operatorname{rank}_\varepsilon(H_p)$ 约束在 $D_{\rm eff}^2$ 附近。

------

### 2. 实验设置（整体结构）

#### 2.1 全局参数

- 字母表：$\Sigma=\{0,1\}$，$|\Sigma|=2$。

- 序列长度：$L\in\{8,10,12\}$。

- 初始最大键维：$D_{\max}\in\{8,16\}$（根据算力选一个即可）。

- 截断后的有效键维集合：
  $$
  D_{\rm eff}\in\{D_{\max},\ D_{\max}/2,\ D_{\max}/4\}.
  $$

- 随机基态数量：$N_{\text{base}}\approx 20$。对每个 base MPS 都做一串不同的 $D_{\rm eff}$ 截断，形成多个数据点。

#### 2.2 基态 MPS 的生成与规范化

建议使用“物理一点”的方式（便于跟 12 章的量子通道故事对齐）：

1. 选定物理比特数 $n=L$，初态 $|0\rangle^{\otimes n}$。
2. 构造一个深度足够的随机量子电路：
   - 每层用 Haar 随机的双比特门作用在相邻比特上（1-2, 3-4, …）；
   - 交替偶数/奇数层，形成 brickwork 结构；
   - 总深度例如取 $O(L)$，保证“纠缠够泛”。
3. 用标准 MPS 工具把最终态写成 MPS，并做一次**canonical 化**（左或右规范形式），此时每个切分处都能读出 Schmidt 奇异值。
4. 如有必要，把 MPS 再提升到统一的最大键维 $D_{\max}$（例如补零），以便后续统一截断。

> 备注：
>  如果实现上嫌麻烦，也可以直接采样随机 MPS（和实验 1 的方式类似），关键是要有“足够丰富的纠缠谱”，能看见不同的 tail energy。

#### 2.3 截断策略与尾能量记录

对每个 base MPS，依次处理不同的 $D_{\rm eff}$：

1. 把 base MPS 放到**规范形**（例如左规范），在每个 bond 处都有 Schmidt 奇异值向量 $\lambda^{(t)}$。

2. 对每个切分 $t$：

   - 保留前 $D_{\rm eff}$ 个 Schmidt 系数，定义：
     $$
     \epsilon_t^2 := \sum_{i>D_{\rm eff}} (\lambda^{(t)}_i)^2,
     $$

   - 使用标准 MPS rounding：把“截断后的 Schmidt”重新吸回邻近张量，得到新的 MPS $\tilde\psi^{(D_{\rm eff})}$（即 rank-$D_{\rm eff}$ 的近似）。

3. 对每个 $D_{\rm eff}$：

   - 记录总 tail energy：
     $$
     E_{\text{tail}} := \Big(\sum_t \epsilon_t^2\Big)^{1/2};
     $$

   - 用内积 contraction 计算状态差：
     $$
     \delta_\psi := \|\psi-\tilde\psi\|_2.
     $$

**理论对照：**

- 检查 $\delta_\psi \le E_{\text{tail}}$ 是否成立（MPS rounding 引理）。
- 后续 Hankel 误差要和 $E_{\text{tail}}$ 以及 $2E_{\text{tail}}$ 对比。

------

### 3. Hankel 矩阵构造与误差度量

#### 3.1 统一的 Hankel 视角（避免“重复计数”）

为了和定理 4.2 的推导更干净地对应，我们采用**固定切分点的长度-$L$ Hankel**：

- 固定 $t_*=\lfloor L/2\rfloor$。

- 定义前缀集合 $P=\Sigma^{t_*}$，后缀集合 $S=\Sigma^{L-t_*}$。

- 每个 $(u,v)\in P\times S$ 唯一对应一个长度为 $L$ 的串：
  $$
  x = uv.
  $$
  不再考虑“所有 $|u|+|v|=L$ 的组合”，避免一个字符串重复多次导致 Frobenius 范数多出 $\sqrt{L+1}$ 的因子，直接做到“一一对应”。

在这个定义下，如果你把 $H_p$ 的条目按行优先 flatten 成向量，它和概率向量 $p(x)$ 只是一个重排；因此：
$$
\|H_p-\tilde H_p\|_F = \|p-\tilde p\|_2,
$$
这和 4.2 中的“$\||\psi|^2-|\tilde\psi|^2\|_2$”是完全一致的。

#### 3.2 概率与 Hankel 的实际计算

对每个 base MPS 及每个 $D_{\rm eff}$：

1. 枚举所有 $x\in\Sigma^L$：

   - 对原始态：
     $$
     \psi(x)=\alpha^\top\Big(\prod_{t=1}^L A_t(x_t)\Big)\beta,\quad p(x)=|\psi(x)|^2;
     $$

   - 对截断态：
     $$
     \tilde\psi(x),\quad \tilde p(x)=|\tilde\psi(x)|^2.
     $$

2. 构造 Hankel：

   - 对每个 $u\in P, v\in S$，令 $x=uv$，
     $$
     H_p(u,v)=p(x),\quad \tilde H_p(u,v)=\tilde p(x).
     $$

矩阵大小仅为 $|P|\times|S|=2^{t_*}\times 2^{L-t_*}$：

- 例如 $L=12\Rightarrow t_*=6$，Hankel 为 $64\times 64$，非常轻量。

#### 3.3 误差度量

对每个 base MPS、每个 $D_{\rm eff}$：

1. **Hankel 差的谱范数 & Frobenius 范数**：
   $$
   \Delta_{H,2} := \|H_p-\tilde H_p\|_2,\quad
   \Delta_{H,F} := \|H_p-\tilde H_p\|_F.
   $$

2. **理论上界：**
   $$
   \Delta_{\text{th}} := 2E_{\text{tail}} = 2\Big(\sum_t\epsilon_t^2\Big)^{1/2}.
   $$

3. **状态差：**
   $$
   \delta_\psi = \|\psi-\tilde\psi\|_2.
   $$

**预期关系：**

- 有
  $$
  \Delta_{H,2} \le \Delta_{H,F} = \|p-\tilde p\|_2 \le (\|\psi\|_2+\|\tilde\psi\|_2)\|\psi-\tilde\psi\|_2\approx 2\delta_\psi,
  $$
  且 $\delta_\psi\le E_{\text{tail}}$，所以
  $$
  \Delta_{H,2}\ \lesssim\ 2E_{\text{tail}} = \Delta_{\text{th}}.
  $$

- 在随机样本下，$\Delta_{H,2}$ vs $E_{\text{tail}}$ 之间很可能呈现近似线性关系（斜率 < 2）。

------

### 4. 有效秩（验证推论 4.3）

#### 4.1 数值 rank 的定义

和实验 1 保持一致：

- 对 $H_p$ 做 SVD：$H_p=U\Sigma V^\dagger$，奇异值 $\sigma_1\ge\cdots$；

- 对给定容差 $\varepsilon$，定义有效秩：
  $$
  \operatorname{rank}_\varepsilon(H_p) := \#\{i:\sigma_i\ge \varepsilon\}.
  $$

- 实验中重点考察两类容差：

  1. 与截断误差关联的容差：
     $$
     \varepsilon = \Delta_{\text{th}} = 2E_{\text{tail}};\quad
     \varepsilon = \Delta_{H,2}.
     $$

  2. 若想画曲线，可以扫描一串值（例如 $\varepsilon$ 在 $[10^{-6},10^{-1}]$ 的 log-scale 网格）。

#### 4.2 验证方式

对每个 base MPS、每个 $D_{\rm eff}$：

1. 计算：

   - $\operatorname{rank}_{\Delta_{\text{th}}}(H_p)$；
   - $\operatorname{rank}_{\Delta_{H,2}}(H_p)$。

2. 检查是否满足：
   $$
   \operatorname{rank}_{\Delta_{\text{th}}}(H_p)\le D_{\rm eff}^2,\qquad
   \operatorname{rank}_{\Delta_{H,2}}(H_p)\le D_{\rm eff}^2
   $$
   （允许极少数由于数值噪声略微超出的点，例如超出 1–2 维）。

3. 统计在所有实验点上的“成功率”（即满足 $\le D_{\rm eff}^2$ 的样本比例）。

**预期：**

- 对于大多数样本，在 $\varepsilon\ge \Delta_{\text{th}}$（尤其是 $\varepsilon = \Delta_{H,2}$）时，都能观察到：
  $$
  \operatorname{rank}_\varepsilon(H_p) \approx D_{\rm eff}^2,
  $$
  即“有效秩”明显从 $D_{\max}^2$ 降到 $D_{\rm eff}^2$ 附近。

- 这会非常直观地展示：**低纠缠截断 ⇒ Hankel 有效秩降低**。

------

### 5. 指标与可视化（你在提纲中那两张图的完整版）

#### 5.1 图 1：$\|H_p-\tilde H_p\|_2$ vs $(\sum_t\epsilon_t^2)^{1/2}$

- 横轴：$x = E_{\text{tail}} = \big(\sum_t\epsilon_t^2\big)^{1/2}$（log 或线性坐标均可）；
- 纵轴：$y = \Delta_{H,2} = \|H_p-\tilde H_p\|_2$；
- 每个点代表一个 (base MPS, $D_{\rm eff}$) 组合；
- 再画上参考直线：
  - $y=E_{\text{tail}}$；
  - $y=2E_{\text{tail}}$。

**预期：**

- 所有点都落在 $y=2x$ 之下，验证定理 4.2 的上界；
- 整体呈近似线性趋势，说明这个上界在数量级上是紧的。

#### 5.2 图 2：有效秩 vs $D_{\rm eff}^2$

- 对每个 base MPS、每个 $D_{\rm eff}$：
  - 计算 $r_{\text{eff}} := \operatorname{rank}_{\Delta_{H,2}}(H_p)$；
- 作图方式 1：
  - 横轴：$D_{\rm eff}^2$；
  - 纵轴：$r_{\text{eff}}$；
  - 每个点一个样本，可以加一条 $y=x$ 参考线。
- 作图方式 2（更统计一点）：
  - 对每个 $D_{\rm eff}$，画 $r_{\text{eff}}/D_{\rm eff}^2$ 的箱型图或直方图。

**预期：**

- 大多数据点位于或略低于 $y=x$ 附近；
- 随着 $D_{\rm eff}$ 降低，$r_{\text{eff}}$ 也同步下降，说明“只要把 MPS 截到低纠缠，Hankel 自动变成低有效秩”。

------

### 6. 实验流程小结（伪代码级）

大致流程可以写成这样（逻辑）：

1. 选定 $\Sigma,L,D_{\max},\{D_{\rm eff}\},N_{\text{base}}$。
2. For base_idx in 1..N_base：
   1. 生成随机高纠缠 MPS（键维 $D_{\max}$），规范化；
   2. 对该 MPS，做一次“全局 canonical + 读取 Schmidt 谱”；
   3. For each $D_{\rm eff}$：
      1. 在每个 bond 上按奇异值截断到 $D_{\rm eff}$，记录 $\epsilon_t^2$，得到截断态 $\tilde\psi$；
      2. 计算 $E_{\text{tail}}=(\sum_t\epsilon_t^2)^{1/2}$ 和 $\delta_\psi=\|\psi-\tilde\psi\|_2$；
      3. 枚举所有 $x\in\Sigma^L$，得到 $p(x)$ 和 $\tilde p(x)$；
      4. 用固定切分点 $t_*$ 构造 $H_p,\tilde H_p$；
      5. 计算 $\Delta_{H,2}=\|H_p-\tilde H_p\|_2$、$\Delta_{H,F}=\|H_p-\tilde H_p\|_F$；
      6. 取 $\varepsilon = \Delta_{H,2}$，计算 $r_{\text{eff}}=\operatorname{rank}_\varepsilon(H_p)$。
3. 汇总所有数据点，画出 5.1 和 5.2 两类图。

------

### 7. 在论文里的典型总结句式（示意）

> 我们从键维为 $D_{\max}\in\{8,16\}$ 的随机 MPS（由随机双比特量子电路生成）出发，在每个 Schmidt 切分处执行最优秩-$D_{\rm eff}$ 截断，并记录尾能量 $\epsilon_t^2$。对每个截断态 $\tilde\psi$ 构造对应的概率 Hankel 矩阵 $\tilde H_p$，测量误差 $\Delta_{H,2}=\|H_p-\tilde H_p\|_2$。
>  图 2(a) 显示了 $\Delta_{H,2}$ 相对于 $(\sum_t\epsilon_t^2)^{1/2}$ 的散点图，所有点均被理论上界 $\Delta_{H,2}\le 2(\sum_t\epsilon_t^2)^{1/2}$ 所支配，并呈现出近似线性关系，验证了定理 4.2 的数量级精度。
>  此外，我们在容差 $\varepsilon=\Delta_{H,2}$ 下计算概率 Hankel 的有效秩 $\operatorname{rank}_\varepsilon(H_p)$。图 2(b) 表明，对于所有配置，$\operatorname{rank}_\varepsilon(H_p)$ 始终不超过 $D_{\rm eff}^2$，且典型上接近 $D_{\rm eff}^2$，与推论 4.3 的预测一致。这一实验结果直接展示了：当 MPS 的纠缠谱具有快速衰减、可被小键维 $D_{\rm eff}$ 良好近似时，概率 Hankel 矩阵的有效秩也随之缩减，从而为我们后续的低秩谱学习方法提供了经验支撑。